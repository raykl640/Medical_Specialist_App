<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Resources Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e3f2fd;
        }

        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            min-height: 45px;
            background: white;
        }

        .tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag .remove-tag:hover {
            opacity: 1;
        }

        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            padding: 5px;
            font-size: 0.9rem;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .search-filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .search-filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .resources-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .resource-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e3f2fd;
            transition: all 0.3s ease;
            position: relative;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .resource-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        }

        .resource-content {
            padding: 20px;
        }

        .resource-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .resource-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .resource-category {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .resource-summary {
            color: #5d6d7e;
            line-height: 1.6;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .resource-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .resource-tag {
            background: #f8f9fa;
            color: #495057;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            border: 1px solid #dee2e6;
        }

        .resource-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .btn-edit {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-delete {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        .btn-view {
            background: linear-gradient(45deg, #007bff, #6f42c1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .error {
            background: #ffe6e6;
            color: #d63384;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #e8f5e8;
            color: #198754;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }

        .resource-id {
            font-size: 0.7rem;
            color: #6c757d;
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e3f2fd;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-filter-row {
                grid-template-columns: 1fr;
            }
            
            .resources-grid {
                grid-template-columns: 1fr;
            }
            
            .resource-actions {
                flex-direction: column;
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3f2fd;
        }

        .close-modal {
            background: none;
            color: #adb5bd;
            font-size: 1.5rem;
            padding: 5px;
            width: auto;
            height: auto;
        }

        .close-modal:hover {
            color: #dc3545;
            transform: none;
            box-shadow: none;
        }

        .resource-detail-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .resource-content-full {
            line-height: 1.8;
            color: #495057;
            white-space: pre-wrap;
        }

        .external-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
        }

        .external-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
 <!-- Title Bar -->
    <div class="title-bar">
        <div class="hamburger-menu">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </div>
        <div class="notifications">
            <span class="notification-icon">üîî</span>
        </div>
    </div>
    
    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Navigation Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-circle">
                 <div class="profile-picture" id="userInitial">
                        U
                </div>
            </div>
        </div>
        <div class="nav-section">
             <ul>
                <li><a href="adminIndex.html" class="nav-link active" onclick="loadPage('dashboard')"><span class="icon">üè†</span>Dashboard</a></li>
                    <li><a href="adminpatients.html" class="nav-link" onclick="loadPage('appointments')"><span class="icon">üë§</span>Patients</a></li>
                    <li><a href="adminClinics.html" class="nav-link" onclick="loadPage('clinics')"><span class="icon">üè•</span>Clinics</a></li>
                    <li><a href="adminAppointments.html" class="nav-link" onclick="loadPage('health-resources')"><span class="icon">üìÖ</span>Appointments</a></li>
                    <li><a href="systemLogs.html" class="nav-link" onclick="loadPage('health-resources')"><span class="icon">‚öôÔ∏è</span>System logs</a></li>
                    <li><a href="reports.html" class="nav-link" onclick="loadPage('health-resources')"><span class="icon">üìÅ</span>Reports</a></li>
                    <li><a href="HealthResources.html" class="nav-link" onclick="loadPage('health-resources')"><span class="icon">üìö</span>Health Resources</a></li>
                </ul>
        </div>
        <div class="nav-section nav-bottom">
            <ul>
                <li><a href="#" class="nav-link" id="logout-link"><span class="icon">‚èª</span> Log Out</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1>üìö Medical Resources Management</h1>
        
        <!-- Statistics Section -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalResources">0</div>
                <div class="stat-label">Total Resources</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCategories">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentlyAdded">0</div>
                <div class="stat-label">Added This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTags">0</div>
                <div class="stat-label">Unique Tags</div>
            </div>
        </div>

        <!-- Add New Resource Form -->
        <div class="form-section">
            <h2>‚ûï Add New Medical Resource</h2>
            <form id="resourceForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Resource Title *</label>
                        <input type="text" id="title" name="title" required placeholder="Enter resource title">
                    </div>
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Neurology">Neurology</option>
                            <option value="Oncology">Oncology</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="Orthopedics">Orthopedics</option>
                            <option value="Dermatology">Dermatology</option>
                            <option value="Psychiatry">Psychiatry</option>
                            <option value="Radiology">Radiology</option>
                            <option value="Emergency Medicine">Emergency Medicine</option>
                            <option value="General Medicine">General Medicine</option>
                            <option value="Pharmacology">Pharmacology</option>
                            <option value="Public Health">Public Health</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="imageUrl">Image URL</label>
                        <input type="url" id="imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="form-group">
                        <label for="externalLink">External Link</label>
                        <input type="url" id="externalLink" name="externalLink" placeholder="https://example.com/article">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="summary">Summary *</label>
                    <textarea id="summary" name="summary" required placeholder="Brief summary of the resource (max 200 characters)" maxlength="200"></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="content">Article Content *</label>
                    <textarea id="content" name="content" required placeholder="Full article content..." style="min-height: 200px;"></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="tags">Tags (press Enter to add)</label>
                    <div class="tags-input" id="tagsContainer">
                        <input type="text" class="tag-input" id="tagInput" placeholder="Add tags...">
                    </div>
                </div>

                <button type="submit">üìö Add Resource</button>
            </form>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <h2>üîç Search & Filter Resources</h2>
            <div class="search-filter-row">
                <div class="form-group">
                    <label for="searchInput">Search Resources</label>
                    <input type="text" id="searchInput" placeholder="Search by title, content, or tags...">
                </div>
                <div class="form-group">
                    <label for="categoryFilter">Filter by Category</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sortBy">Sort By</label>
                    <select id="sortBy">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="title">Title A-Z</option>
                        <option value="category">Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" id="clearFilters">üîÑ Clear</button>
                </div>
            </div>
        </div>

        <!-- Resources Display Section -->
        <div class="resources-section">
            <h2>üìñ Medical Resources Library</h2>
            <div id="resourcesList">
                <div class="loading">Loading resources...</div>
            </div>
        </div>
    </div>

    <!-- Resource Detail Modal -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Resource Details</h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script type="module" src="js/admin/adminNavigation.js"></script>
    <script src="./js/index.js"></script>

    <script type="module">
        // Import centralized Firebase config and services
        import { app, db } from "./js/firebase-config.js";
        import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Utility functions (reuse your utils object as before)
        const utils = {
            escapeHtml: (text) => {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            showMessage: (message, type = 'info') => {
                const messageDiv = document.createElement('div');
                messageDiv.className = type === 'error' ? 'error' : 'success';
                messageDiv.textContent = message;
                
                const container = document.querySelector('.container');
                container.insertBefore(messageDiv, container.firstChild);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            },
            
            generateResourceId: () => {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substring(2, 8);
                return `RES_${timestamp}_${randomStr}`.toUpperCase();
            },

            formatDate: (timestamp) => {
                if (!timestamp) return new Date().toLocaleDateString();
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            },

            truncateText: (text, maxLength) => {
                if (!text || text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }
        };

        // Firestore service for medical resources
        const resourceService = {
            async getAllResources() {
                const snapshot = await getDocs(collection(db, 'healthResources'));
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            async addResource(resourceData) {
                const docRef = await addDoc(collection(db, 'healthResources'), {
                    ...resourceData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                return docRef.id;
            },
            async updateResource(resourceId, resourceData) {
                await updateDoc(doc(db, 'healthResources', resourceId), {
                    ...resourceData,
                    updatedAt: serverTimestamp()
                });
            },
            async deleteResource(resourceId) {
                await deleteDoc(doc(db, 'healthResources', resourceId));
            }
        };

        // Replace allResources and filteredResources with Firestore data
        let allResources = [];
        let filteredResources = [];
        let selectedTags = [];
        let currentEditingId = null;

        // Tags management
        const tagsManager = {
            init() {
                const tagInput = document.getElementById('tagInput');
                
                tagInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addTag(tagInput.value.trim());
                        tagInput.value = '';
                    }
                });

                tagInput.addEventListener('blur', () => {
                    if (tagInput.value.trim()) {
                        this.addTag(tagInput.value.trim());
                        tagInput.value = '';
                    }
                });
            },

            addTag(tagText) {
                if (!tagText || selectedTags.includes(tagText.toLowerCase())) return;
                
                selectedTags.push(tagText.toLowerCase());
                this.renderTags();
            },

            removeTag(tagText) {
                selectedTags = selectedTags.filter(tag => tag !== tagText);
                this.renderTags();
            },

            renderTags() {
                const tagsContainer = document.getElementById('tagsContainer');
                const tagInput = document.getElementById('tagInput');
                
                tagsContainer.innerHTML = '';
                
                selectedTags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${utils.escapeHtml(tag)}
                        <span class="remove-tag" onclick="tagsManager.removeTag('${tag}')">√ó</span>
                    `;
                    tagsContainer.appendChild(tagElement);
                });
                
                tagsContainer.appendChild(tagInput);
            },

            getTags() {
                return selectedTags;
            },

            clearTags() {
                selectedTags = [];
                this.renderTags();
            },

            setTags(tags) {
                selectedTags = [...tags];
                this.renderTags();
            }
        };

        // UI Management
        const ui = {
            displayResources(resources) {
                const resourcesList = document.getElementById('resourcesList');
                
                if (!resources || resources.length === 0) {
                    resourcesList.innerHTML = '<div class="loading">No resources found. Add your first medical resource above! üìö</div>';
                    return;
                }
                
                const resourcesGrid = document.createElement('div');
                resourcesGrid.className = 'resources-grid';
                
                resourcesGrid.innerHTML = resources.map(resource => {
                    const title = utils.escapeHtml(resource.title);
                    const summary = utils.escapeHtml(resource.summary);
                    const category = utils.escapeHtml(resource.category);
                    const resource_Id = resource.resource_Id || 'N/A';
                    const imageUrl = resource.imageUrl || 'https://via.placeholder.com/400x200/667eea/ffffff?text=Medical+Resource';
                    
                    return `
                        <div class="resource-card">
                            <img src="${imageUrl}" alt="${title}" class="resource-image" onerror="this.src='https://via.placeholder.com/400x200/667eea/ffffff?text=Medical+Resource'">
                            <div class="resource-content">
                                <div class="resource-id">ID: ${resource_Id}</div>
                                <h3 class="resource-title">${title}</h3>
                                <div class="resource-meta">
                                    <span class="resource-category">${category}</span>
                                    <span>${utils.formatDate(resource.createdAt?.seconds ? resource.createdAt.seconds * 1000 : resource.createdAt)}</span>
                                </div>
                                <p class="resource-summary">${summary}</p>
                                <div class="resource-tags">
                                    ${resource.tags ? resource.tags.map(tag => 
                                        `<span class="resource-tag">${utils.escapeHtml(tag)}</span>`
                                    ).join('') : ''}
                                </div>
                                <div class="resource-actions">
                                    <button class="btn-small btn-view" onclick="viewResource('${resource.id}')">
                                        üëÅÔ∏è View
                                    </button>
                                    <button class="btn-small btn-edit" onclick="editResource('${resource.id}')">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn-small btn-delete" onclick="deleteResource('${resource.id}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resourcesList.innerHTML = '';
                resourcesList.appendChild(resourcesGrid);
            },

            updateStats() {
                const categories = [...new Set(allResources.map(r => r.category))].length;
                const recentlyAdded = allResources.filter(r => 
                    Date.now() - r.createdAt?.seconds * 1000 < 7 * 24 * 60 * 60 * 1000
                ).length;
                const allTags = [...new Set(allResources.flatMap(r => r.tags || []))].length;
                
                document.getElementById('totalResources').textContent = allResources.length;
                document.getElementById('totalCategories').textContent = categories;
                document.getElementById('recentlyAdded').textContent = recentlyAdded;
                document.getElementById('totalTags').textContent = allTags;
            },

            populateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                const categories = [...new Set(allResources.map(r => r.category))].sort();
                
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }
        };

        // Search and Filter functionality
        const searchFilter = {
            init() {
                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');
                const sortBy = document.getElementById('sortBy');
                const clearFilters = document.getElementById('clearFilters');

                searchInput.addEventListener('input', this.applyFilters.bind(this));
                categoryFilter.addEventListener('change', this.applyFilters.bind(this));
                sortBy.addEventListener('change', this.applyFilters.bind(this));
                clearFilters.addEventListener('click', this.clearAllFilters.bind(this));
            },

            applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                let filtered = [...allResources];

                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(resource => {
                        return (
                            resource.title.toLowerCase().includes(searchTerm) ||
                            resource.content.toLowerCase().includes(searchTerm) ||
                            resource.summary.toLowerCase().includes(searchTerm) ||
                            (resource.tags && resource.tags.some(tag => 
                                tag.toLowerCase().includes(searchTerm)
                            ))
                        );
                    });
                }

                // Apply category filter
                if (categoryFilter) {
                    filtered = filtered.filter(resource => resource.category === categoryFilter);
                }

                // Apply sorting
                filtered.sort((a, b) => {
                    switch (sortBy) {
                        case 'newest':
                            return b.createdAt?.seconds * 1000 - a.createdAt?.seconds * 1000;
                        case 'oldest':
                            return a.createdAt?.seconds * 1000 - b.createdAt?.seconds * 1000;
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'category':
                            return a.category.localeCompare(b.category);
                        default:
                            return b.createdAt?.seconds * 1000 - a.createdAt?.seconds * 1000;
                    }
                });

                filteredResources = filtered;
                ui.displayResources(filtered);
            },

            clearAllFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('sortBy').value = 'newest';
                this.applyFilters();
            }
        };

        // Form management
        const formManager = {
            init() {
                const form = document.getElementById('resourceForm');
                form.addEventListener('submit', this.handleSubmit.bind(this));
            },

            async handleSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const resourceData = {
                    title: formData.get('title').trim(),
                    category: formData.get('category'),
                    summary: formData.get('summary').trim(),
                    content: formData.get('content').trim(),
                    imageUrl: formData.get('imageUrl').trim() || null,
                    externalLink: formData.get('externalLink').trim() || null,
                    tags: tagsManager.getTags()
                };

                // Validation
                if (!resourceData.title || !resourceData.category || !resourceData.summary || !resourceData.content) {
                    utils.showMessage('Please fill in all required fields.', 'error');
                    return;
                }

                if (resourceData.summary.length > 200) {
                    utils.showMessage('Summary must be 200 characters or less.', 'error');
                    return;
                }

                try {
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = currentEditingId ? 'üîÑ Updating...' : 'üîÑ Adding...';

                    if (currentEditingId) {
                        await resourceService.updateResource(currentEditingId, resourceData);
                        utils.showMessage('Resource updated successfully! ‚úÖ', 'success');
                        this.cancelEdit();
                    } else {
                        await resourceService.addResource(resourceData);
                        utils.showMessage('Resource added successfully! ‚úÖ', 'success');
                    }

                    this.resetForm();
                    await loadAndDisplayResources();
                    
                } catch (error) {
                    console.error('Error saving resource:', error);
                    utils.showMessage(error.message, 'error');
                } finally {
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    submitButton.disabled = false;
                    submitButton.innerHTML = currentEditingId ? 'üìù Update Resource' : 'üìö Add Resource';
                }
            },

            resetForm() {
                document.getElementById('resourceForm').reset();
                tagsManager.clearTags();
            },

            populateForm(resource) {
                document.getElementById('title').value = resource.title || '';
                document.getElementById('category').value = resource.category || '';
                document.getElementById('summary').value = resource.summary || '';
                document.getElementById('content').value = resource.content || '';
                document.getElementById('imageUrl').value = resource.imageUrl || '';
                document.getElementById('externalLink').value = resource.externalLink || '';
                
                tagsManager.setTags(resource.tags || []);
            },

            startEdit(resourceId) {
                const resource = allResources.find(r => r.id === resourceId);
                if (!resource) return;

                currentEditingId = resourceId;
                this.populateForm(resource);
                
                const submitButton = document.querySelector('#resourceForm button[type="submit"]');
                submitButton.innerHTML = 'üìù Update Resource';
                
                // Add cancel button
                if (!document.getElementById('cancelEdit')) {
                    const cancelButton = document.createElement('button');
                    cancelButton.type = 'button';
                    cancelButton.id = 'cancelEdit';
                    cancelButton.innerHTML = '‚ùå Cancel Edit';
                    cancelButton.style.marginLeft = '10px';
                    cancelButton.onclick = () => this.cancelEdit();
                    submitButton.parentNode.appendChild(cancelButton);
                }

                // Scroll to form
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            },

            cancelEdit() {
                currentEditingId = null;
                this.resetForm();
                
                const submitButton = document.querySelector('#resourceForm button[type="submit"]');
                submitButton.innerHTML = 'üìö Add Resource';
                
                const cancelButton = document.getElementById('cancelEdit');
                if (cancelButton) {
                    cancelButton.remove();
                }
            }
        };

        // Main application functions
        async function loadAndDisplayResources() {
            try {
                allResources = await resourceService.getAllResources();
                filteredResources = [...allResources];
                ui.displayResources(filteredResources);
                ui.updateStats();
                ui.populateCategoryFilter();
            } catch (error) {
                console.error('Error loading resources:', error);
                utils.showMessage('Error loading resources. Please refresh the page.', 'error');
            }
        }

        // Edit and delete handlers
        window.editResource = function(resourceId) {
            formManager.startEdit(resourceId);
        };
        window.deleteResource = async function(resourceId) {
            const resource = allResources.find(r => r.id === resourceId);
            if (!resource) return;
            if (!confirm(`Are you sure you want to delete "${resource.title}"?`)) return;
            try {
                await resourceService.deleteResource(resourceId);
                utils.showMessage('Resource deleted successfully! üóëÔ∏è', 'success');
                await loadAndDisplayResources();
            } catch (error) {
                console.error('Error deleting resource:', error);
                utils.showMessage(error.message, 'error');
            }
        };

        // Modal functionality
        window.viewResource = function(resourceId) {
            const resource = allResources.find(r => r.id === resourceId);
            if (!resource) return;
            const modal = document.getElementById('resourceModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            modalTitle.textContent = resource.title;
            const imageHtml = resource.imageUrl ?
                `<img src="${resource.imageUrl}" alt="${utils.escapeHtml(resource.title)}" class="resource-detail-image" onerror="this.style.display='none'">` : '';
            const externalLinkHtml = resource.externalLink ?
                `<a href="${resource.externalLink}" target="_blank" class="external-link">üîó View External Resource</a>` : '';
            modalBody.innerHTML = `
                <div class="resource-id">Resource ID: ${resource.resource_Id || 'N/A'}</div>
                ${imageHtml}
                <div class="resource-meta">
                    <span class="resource-category">${utils.escapeHtml(resource.category)}</span>
                    <span>Created: ${utils.formatDate(resource.createdAt?.seconds ? resource.createdAt.seconds * 1000 : resource.createdAt)}</span>
                    ${resource.updatedAt !== resource.createdAt ?
                        `<span>Updated: ${utils.formatDate(resource.updatedAt?.seconds ? resource.updatedAt.seconds * 1000 : resource.updatedAt)}</span>` : ''}
                </div>
                <div class="resource-tags" style="margin: 15px 0;">
                    ${resource.tags ? resource.tags.map(tag =>
                        `<span class="resource-tag">${utils.escapeHtml(tag)}</span>`
                    ).join('') : ''}
                </div>
                <h3 style="margin: 20px 0 10px 0; color: #2c3e50;">Summary</h3>
                <p style="color: #5d6d7e; line-height: 1.6; margin-bottom: 20px;">${utils.escapeHtml(resource.summary)}</p>
                <h3 style="margin: 20px 0 10px 0; color: #2c3e50;">Full Content</h3>
                <div class="resource-content-full">${utils.escapeHtml(resource.content)}</div>
                ${externalLinkHtml}
            `;
            modal.style.display = 'block';
        };
        window.closeModal = function() {
            document.getElementById('resourceModal').style.display = 'none';
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize all modules
                tagsManager.init();
                formManager.init();
                searchFilter.init();
                
                // Load and display resources
                await loadAndDisplayResources();
                
                console.log('Medical Resources Management System initialized with Firestore!');
            } catch (error) {
                console.error('Failed to initialize application:', error);
                utils.showMessage('Failed to initialize application. Please refresh the page.', 'error');
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('resourceModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // ESC to close modal
            if (event.key === 'Escape') {
                closeModal();
            }
            
            // Ctrl+K to focus search
            if (event.ctrlKey && event.key === 'k') {
                event.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });
    </script>
</body>
</html>